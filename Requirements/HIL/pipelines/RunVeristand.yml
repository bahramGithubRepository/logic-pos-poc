run_veristand_tests:
  stage: Run Veristand Tests
  tags:
    - HIL_Demo_Computer
  variables:
    VS_SERVER: "C:\\Program\ Files\\National\ Instruments\\VeriStand\ 2025\\veristand-server.exe"
    ROOT_DIR: "$CI_PROJECT_DIR"

  script:
    - powershell -Command "if ((Get-Service NetPipeActivator).Status -ne 'Running') { Start-Service NetPipeActivator }"
    - powershell -Command "Start-Service -Name 'WAS'"

    # Set up Python environment
    - Write-Host 'Setting up virtual environment...'
    - Set-Location '4_Automation\\ConnectionToHil'
    - $env:Path = "C:\Users\TA_HILSolutions\.pyenv\pyenv-win\versions\3.8.10;C:\Users\TA_HILSolutions\.pyenv\pyenv-win\versions\3.8.10\Scripts;" + $env:Path
    - python -m venv venv
    - .\\venv\\Scripts\\Activate.ps1
    - pip install -r requirements.txt
    - Write-Host 'Virtual environment setup complete.'
    - $env:PYTHONPATH = (Resolve-Path .).Path

    # Silently start Veristand Gateway and deploy project
    - Write-Host 'Starting VeriStand Gateway (silent mode)...'
    - powershell -Command "& `'$env:VS_SERVER`' start"
    - Write-Host 'Deploying crio project...'
    - powershell -Command "& `'$env:VS_SERVER`' deploy `'$env:ROOT_DIR\5_Veristand\cRIO\cRIO.nivssdf`'"

    # Run Pytest
    - Write-Host 'Running pytest with config file...'
    - pytest -v tests --junitxml=report.xml -s

    # Stop veristand gateway
    - powershell -Command "& `'$env:VS_SERVER`' undeploy"

  artifacts:
    when: always
    paths:
      - 4_Automation/ConnectionToHil/report.xml
    reports:
      junit: 4_Automation/ConnectionToHil/report.xml
